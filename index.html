<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Idle Miner - Play to Earn</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background: linear-gradient(135deg,#1a1c4e 0%,#2a2d72 100%); color:#f5f6fa; min-height:100vh; padding:20px; }
.container { max-width:1000px; margin:0 auto; background:rgba(30,30,44,0.85); border-radius:20px; padding:20px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
header { text-align:center; padding:20px 0; border-bottom:2px solid #ff9f43; margin-bottom:20px; }
h1 { font-size:2.5rem; color:#ff9f43; text-shadow:2px 2px 5px rgba(0,0,0,0.5); margin-bottom:10px; }
.subtitle { font-size:1.2rem; color:#00cfc8; }
.game-container { display:grid; grid-template-columns:1fr 320px; gap:20px; margin-top:20px; }
.mine-area { background:rgba(42,45,114,0.6); border-radius:15px; padding:20px; text-align:center; position:relative; }
.mine-shaft { width:220px; height:320px; background:linear-gradient(to bottom,#3a3a3a,#1a1a1a); margin:0 auto; border:4px solid #8c7b6b; border-radius:12px; position:relative; overflow:hidden; }
.miner { width:40px; height:40px; background:#ff9f43; border-radius:50%; position:absolute; bottom:20px; left:90px; animation:mine 1.5s infinite alternate; }
@keyframes mine { 0% { transform:translateY(0); } 50% { transform:translateY(-15px) scale(0.95); } 100% { transform:translateY(0); } }
.resources { margin-top:20px; display:flex; justify-content:center; gap:15px; flex-wrap:wrap; }
.resource { background:rgba(0,207,200,0.2); padding:12px 18px; border-radius:12px; display:flex; align-items:center; gap:8px; font-weight:bold; font-size:1.1rem; transition:transform 0.3s; }
.resource:hover { transform:scale(1.05); }
.sidebar { background:rgba(42,45,114,0.6); border-radius:15px; padding:20px; display:flex; flex-direction:column; justify-content:flex-start; }
.stat { display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); }
.upgrade { background:rgba(0,0,0,0.35); padding:15px; border-radius:12px; margin-bottom:12px; cursor:pointer; transition:all 0.3s; }
.upgrade:hover { background:rgba(0,0,0,0.55); transform:translateY(-3px); box-shadow:0 6px 15px rgba(0,0,0,0.4); }
.btn { background:#ff9f43; color:#1e1e2c; border:none; padding:12px 25px; border-radius:30px; font-weight:bold; cursor:pointer; transition:all 0.3s; display:inline-flex; align-items:center; gap:8px; margin:5px 0; }
.btn:hover { background:#ffaa58; transform:translateY(-2px); box-shadow:0 5px 20px rgba(0,0,0,0.3); }
#welcome { margin-top:10px; color:#00cfc8; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
<header>
<h1>Idle Miner Tycoon</h1>
<p class="subtitle">إجمع الثروة واستمتع! Play-to-Earn</p>
</header>

<div class="game-container">
<div class="mine-area">
<h2>منجم الذهب الرئيسي</h2>
<div class="mine-shaft"><div class="miner"></div></div>
<div class="resources">
<div class="resource"><span>💰</span> <span id="gold">0</span></div>
<div class="resource"><span>⛏️</span> <span id="miners">1</span></div>
<div class="resource"><span>⭐</span> <span id="dailyBonus">0%</span></div>
</div>
<div class="action-buttons">
<button class="btn" onclick="collectGold()">جمع الذهب</button>
<button class="btn" onclick="buyMiner()">شراء عامل (50 ذهب)</button>
<button class="btn" onclick="dailyBonus()">المطالبة بالمكافأة اليومية</button>
</div>
<button class="btn" id="googleLogin">تسجيل الدخول عبر Google</button>
<button class="btn" id="logoutBtn" style="display:none;">تسجيل الخروج</button>
<p id="welcome"></p>
</div>

<div class="sidebar">
<h3>إحصائيات اللاعب</h3>
<div class="stat"><span>النقاط:</span> <span id="points">0</span></div>
<div class="stat"><span>وقت التعدين:</span> <span id="miningTime">0</span> ثانية</div>
<div class="stat"><span>العمال:</span> <span id="minersCount">1</span></div>
</div>
</div>
</div>

<script>
const supabase = supabase.createClient(
"https://ltcpldhijbovvezfenqe.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0Y3BsZGhpamJvdnZlemZlbnFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNDM4MDAsImV4cCI6MjA3MzcxOTgwMH0.LCQ_R5SX5x9v5qb4OT2n1_gyiywLoRJbWMOpYyxv5jo"
);

// تسجيل الدخول عبر Google
document.getElementById('googleLogin').addEventListener('click', async () => {
  const { data, error } = await supabase.auth.signInWithOAuth({ provider: 'google' });
  if (error) console.error(error);
});

// متابعة حالة تسجيل الدخول
supabase.auth.onAuthStateChange(async (event, session) => {
  if (session && session.user) {
    const userId = session.user.id;
    const email = session.user.email;
    const username = session.user.user_metadata.full_name || email;

    document.getElementById('logoutBtn').style.display = 'inline-block';
    document.getElementById('welcome').textContent = `مرحبًا ${username}!`;

    const { data } = await supabase.from('users').select('*').eq('id', userId);
    if (data.length === 0) {
      await supabase.from('users').insert([{ id: userId, email: email, points: 0, mining_time: 0, gold:0, miners:1 }]);
      console.log("✅ مستخدم جديد تم إنشاؤه تلقائيًا");
    }

    getUserData(userId);
    window.currentUserId = userId;
  } else {
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('welcome').textContent = '';
    window.currentUserId = null;
  }
});

// تسجيل الخروج
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut();
  alert("تم تسجيل الخروج!");
  getUserData('');
});

// عرض وتحديث بيانات المستخدم
async function getUserData(userId){
  if(!userId) {
    document.getElementById('points').textContent = 0;
    document.getElementById('miningTime').textContent = 0;
    document.getElementById('gold').textContent = 0;
    document.getElementById('minersCount').textContent = 1;
    return;
  }
  const { data } = await supabase.from('users').select('*').eq('id', userId);
  if(data[0]){
    document.getElementById('points').textContent = data[0].points;
    document.getElementById('miningTime').textContent = data[0].mining_time;
    document.getElementById('gold').textContent = data[0].gold;
    document.getElementById('minersCount').textContent = data[0].miners;
  }
}

// الدوال الأساسية للعبة مع الحفظ التلقائي
async function collectGold(){
  if(!window.currentUserId) return alert("يرجى تسجيل الدخول أولاً");
  let gold = parseInt(document.getElementById('gold').textContent);
  gold += 10;
  document.getElementById('gold').textContent = gold;

  await supabase.from('users').update({ gold }).eq('id', window.currentUserId);
}

async function buyMiner(){
  if(!window.currentUserId) return alert("يرجى تسجيل الدخول أولاً");
  let gold = parseInt(document.getElementById('gold').textContent);
  let miners = parseInt(document.getElementById('minersCount').textContent);
  if(gold < 50) return alert("لا يوجد لديك ما يكفي من الذهب!");
  gold -= 50;
  miners += 1;
  document.getElementById('gold').textContent = gold;
  document.getElementById('minersCount').textContent = miners;

  await supabase.from('users').update({ gold, miners }).eq('id', window.currentUserId);
}

async function dailyBonus(){
  if(!window.currentUserId) return alert("يرجى تسجيل الدخول أولاً");
  let points = parseInt(document.getElementById('points').textContent);
  points += 20;
  document.getElementById('points').textContent = points;

  await supabase.from('users').update({ points }).eq('id', window.currentUserId);
}

// 🔹 الحفظ التلقائي كل 10 ثواني
async function autoSave(){
  if(!window.currentUserId) return;
  const gold = parseInt(document.getElementById('gold').textContent);
  const miners = parseInt(document.getElementById('minersCount').textContent);
  const points = parseInt(document.getElementById('points').textContent);
  const mining_time = parseInt(document.getElementById('miningTime').textContent);

  await supabase.from('users').update({ gold, miners, points, mining_time }).eq('id', window.currentUserId);
  console.log("💾 تم الحفظ التلقائي");
}
setInterval(autoSave, 10000);

</script>
</body>
</html>
